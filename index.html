<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kule Komutanı</title>
    <style>
        /* TEMEL LAYOUT STİLLERİ (EKSİKTİ) */
        html, body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top,#1e2a38,#0d141c 60%);
            font-family: system-ui, Arial, sans-serif;
            color: #ecf0f1;
            overflow-x: hidden;
        }
        .game-container {
            display: flex;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }
        .game-board {
            position: relative;
            width: 1000px;
            height: 500px;
            margin: auto;
            background: linear-gradient(135deg,#2f3640 0%, #3b4b5b 100%);
            border: 4px solid #2c3e50;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            overflow: hidden;
        }
        .grid-cell {
            position: absolute;
            width: 50px;
            height: 50px;
            box-sizing: border-box;
            border: 1px solid rgba(255,255,255,0.06);
            cursor: crosshair;
            transition: background .2s ease, box-shadow .2s ease;
        }
        .grid-cell:hover { background: rgba(255,255,255,0.08); box-shadow: inset 0 0 6px rgba(255,255,255,0.25); }
        .path {
            position: absolute;
            background: repeating-linear-gradient(45deg, #8d6e63, #8d6e63 10px, #7f6157 10px, #7f6157 20px);
            box-shadow: inset 0 0 6px rgba(0,0,0,0.6), 0 0 10px rgba(255,193,113,0.2);
            opacity: 0.9;
            z-index: 2;
        }
        .tower {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 12px;
            color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            user-select: none;
            z-index: 10;
            transition: transform .15s ease;
        }
        .tower:hover { transform: translateY(-4px) scale(1.05); }
        #towerActionsMenu button { font-size: 13px; }

        /* GAME OVER OVERLAY */
        #gameOverOverlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.80);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 28px;
            z-index: 1000;
            font-family: system-ui, Arial, sans-serif;
            color: #ecf0f1;
            text-align: center;
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity .4s ease;
        }
        #gameOverOverlay.active { opacity: 1; pointer-events: all; }
        #gameOverOverlay h1 {
            margin: 0;
            font-size: 72px;
            letter-spacing: 3px;
            background: linear-gradient(90deg,#ff6b6b,#f1c40f,#2ecc71);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            animation: gameOverPulse 3s ease-in-out infinite;
            text-shadow: 0 0 15px rgba(255,255,255,0.15);
        }
        @keyframes gameOverPulse { 0%,100% { transform: scale(1);} 50% { transform: scale(1.05);} }
        #gameOverOverlay .final-stats { font-size: 18px; line-height: 1.4; opacity: .9; }
        #restartButton {
            padding: 14px 36px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            background: linear-gradient(45deg,#3498db,#9b59b6);
            color: #fff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        #restartButton:hover { transform: translateY(-4px) scale(1.04); box-shadow: 0 10px 28px rgba(0,0,0,0.55); }
        #restartButton:active { transform: translateY(1px) scale(.98); }

    /* Onboarding ek CSS */
    #onboardingOverlay { position:absolute; inset:0; background:rgba(0,0,0,0.78); backdrop-filter:blur(4px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:22px; color:#ecf0f1; font-family:system-ui,Arial; text-align:center; z-index:950; opacity:1; transition:opacity .4s ease; }
    #onboardingOverlay.hidden { opacity:0; pointer-events:none; }
    #onboardingOverlay h2 { margin:0 0 4px; font-size:48px; letter-spacing:1px; }
    #onboardingOverlay ol { margin:0; padding-left:22px; max-width:520px; text-align:left; line-height:1.5; font-size:17px; }
    #waveHint { display:none; font-size:12px; opacity:.8; margin-top:-4px; margin-bottom:8px; color:#ffd86b; text-align:center; font-weight:500; }

        /* (Kaydet/Yükle sistemi isteğe bağlı olarak kaldırıldı) */
        .tower-level-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg,#f1c40f,#f39c12);
            color: #1b1b1b;
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            border: 2px solid #ffffff33;
            font-family: system-ui, Arial;
            pointer-events: none;
            z-index: 20;
        }
        .tower-level-badge[data-lv="2"] { background: linear-gradient(45deg,#9b59b6,#8e44ad); color:#fff; }
        .tower-level-badge[data-lv="3"] { background: linear-gradient(45deg,#e74c3c,#c0392b); color:#fff; }

        @keyframes towerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Kule Tiplerinin Renkleri */
        .tower-archer {
            background: radial-gradient(circle, #ff6b6b, #ee5a24);
            border: 3px solid #c44569;
        }

        .tower-mage {
            background: radial-gradient(circle, #4834d4, #686de0);
            border: 3px solid #30336b;
        }

        .tower-cannon {
            background: radial-gradient(circle, #f0932b, #eb4d4b);
            border: 3px solid #6f1e51;
        }

        .tower-ice {
            background: radial-gradient(circle, #00d2d3, #01a3a4);
            border: 3px solid #006ba6;
        }

        /* Kule Eylemleri Menüsü (Yükselt, Sat) */
        .tower-actions {
            position: absolute;
            background: rgba(44, 62, 80, 0.9);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 20; /* Her şeyin üzerinde olsun */
        }

        .action-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .action-button:hover {
            transform: translateY(-2px); /* Hafif yukarı kalkma efekti */
        }

        .upgrade-button {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .upgrade-button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .sell-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        /* Düşmanlar */
        .enemy {
            position: absolute;
            width: 35px; /* Düşman boyutu */
            height: 35px; /* Düşman boyutu */
            border-radius: 50%;
            transition: all 0.05s linear; /* Daha yumuşak hareket için */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            animation: enemyMove 0.5s infinite alternate; /* Hafif yukarı-aşağı hareket */
            z-index: 8;
        }

        @keyframes enemyMove {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-3px); }
        }

        /* Yeni Düşman Tiplerinin Stilleri */
        .enemy-goblin {
            background: radial-gradient(circle, #8bc34a, #4caf50);
            border: 2px solid #388e3c;
            font-size: 16px;
            width: 30px;
            height: 30px;
        }

        .enemy-orc {
            background: radial-gradient(circle, #ff9800, #fb8c00);
            border: 2px solid #f57c00;
            font-size: 18px;
        }

        .enemy-troll {
            background: radial-gradient(circle, #607d8b, #455a64);
            border: 2px solid #263238;
            font-size: 20px;
            width: 40px;
            height: 40px;
        }

        .enemy-shadow {
            background: radial-gradient(circle, #9c27b0, #7b1fa2);
            border: 2px solid #4a148c;
            font-size: 18px;
            filter: brightness(1.2);
        }

        .enemy-golem {
            background: radial-gradient(circle, #795548, #5d4037);
            border: 2px solid #3e2723;
            font-size: 22px;
            width: 50px;
            height: 50px;
        }

        /* Mermiler */
        .projectile {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ffeb3b;
            box-shadow: 0 0 10px #ffeb3b;
            animation: projectileGlow 0.3s infinite alternate; /* Parlama efekti */
            z-index: 12;
        }

        @keyframes projectileGlow {
            0% { box-shadow: 0 0 5px #ffeb3b; }
            100% { box-shadow: 0 0 15px #ffeb3b, 0 0 25px #ffeb3b; }
        }

        /* Kenar Çubuğu (UI Paneli) */
        .sidebar {
            width: 260px; /* Biraz daraltıldı */
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            padding: 14px 14px 10px;
            border-left: 3px solid #3498db;
            overflow-y: auto; /* İçerik taşarsa kaydırma çubuğu */
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar h2 {
            color: #3498db;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* İstatistik Paneli */
        .stats-panel, .tower-shop, .game-controls, .player-status {
            background: rgba(0,0,0,0.3);
            padding: 12px 12px 10px;
            border-radius: 10px;
            margin: 0;
            border: 1px solid rgba(52, 152, 219, 0.25);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value {
            font-weight: bold;
            color: #3498db;
        }

        /* Kule Mağazası Butonları */
        .tower-shop h3 {
            color: #3498db;
            margin-bottom: 15px;
            text-align: center;
        }

        .tower-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 6px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: white; /* Metin rengi varsayılan olarak beyaz */
        }

        /* Buton üzerine gelince parlama efekti */
        .tower-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .tower-button:hover:before {
            left: 100%;
        }

        /* Kule Butonu Renkleri */
        .tower-button.archer { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .tower-button.mage { background: linear-gradient(45deg, #4834d4, #686de0); }
        .tower-button.cannon { background: linear-gradient(45deg, #f0932b, #eb4d4b); }
        .tower-button.ice { background: linear-gradient(45deg, #00d2d3, #01a3a4); }

        .tower-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .tower-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Oyun Kontrol Butonları */
        .game-controls .control-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 6px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white; /* Metin rengi varsayılan olarak beyaz */
        }

        .start-wave { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .pause-game { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }


        /* Düşman Sağlık Çubuğu */
        .health-bar {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 5px;
            background: rgba(0,0,0,0.5);
            border-radius: 3px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.1s linear;
            border-radius: 3px;
        }

        /* Patlama Efekti */
        .explosion {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff6b35, #f7931e);
            animation: explode 0.6s ease-out forwards;
            pointer-events: none; /* Tıklanabilir olmasın */
            z-index: 15;
        }

        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        /* Hasar Metni Efekti */
        .damage-text {
            position: absolute;
            color: #ff6b35;
            font-weight: bold;
            font-size: 18px;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 16;
        }

        @keyframes damageFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Kule Menzil Göstergesi */
        .tower-range {
            position: absolute;
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 50%;
            pointer-events: none;
            background: rgba(255,255,255,0.1);
            animation: rangeIndicator 2s infinite; /* Nabız efekti */
            z-index: 1;
        }

        @keyframes rangeIndicator {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }





        /* Duyarlılık İçin Medya Sorguları */
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column; /* Mobil cihazlarda dikey düzen */
            }

            .sidebar {
                width: 100%; /* Tam genişlik */
                height: auto; /* İçeriğe göre yükseklik */
                max-height: 200px; /* Çok uzun olmasını engeller */
                border-left: none;
                border-top: 3px solid #3498db;
                order: 2; /* Kenar çubuğu oyun tahtasının altına gelir */
            }

            .game-board {
                width: 100vw; /* Ekran genişliğine yayılır */
                height: calc(100vh - 200px); /* Kalan alanı kaplar */
                flex: 1; /* Esnekliği tekrar aktif ederiz */
                margin: 0; /* Ortalamayı kaldırırız */
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-board" id="gameBoard">
            <div id="towerActionsMenu" class="tower-actions" style="display: none;">
                </div>
            <div id="gameOverOverlay">
                <h1>GAME OVER</h1>
                <div class="final-stats" id="finalStats"></div>
                <button id="restartButton" onclick="restartGameFromOverlay()">↻ Yeniden Başla</button>
            </div>
            <div id="onboardingOverlay" style="display:block;">
                <h2>🎯 Nasıl Oynanır</h2>
                <ol>
                    <li>Sağ panelden bir kule seç.</li>
                    <li>Yolun dışındaki kareye tıkla ve yerleştir.</li>
                    <li>Dalga Başlat'a bas ve düşmanları yok et.</li>
                    <li>Kuleye tıklayıp yükselt veya sat.</li>
                    <li>Tüm canlar bitmeden dayan!</li>
                </ol>
                <button class="dismiss-guide" onclick="hideOnboarding()" style="padding:12px 28px;font-size:16px;font-weight:600;border:none;border-radius:12px;background:linear-gradient(45deg,#27ae60,#2ecc71);color:#fff;cursor:pointer;">Hazırım!</button>
            </div>
        </div>

        <div class="sidebar">
            <div>
                <h2>🏰 Kule Komutanı</h2>

                <div class="stats-panel">
                    <div class="stat-item">
                        <span>💰 Altın:</span>
                        <span class="stat-value" id="gold">500</span>
                    </div>
                    <div class="stat-item">
                        <span>❤️ Can:</span>
                        <span class="stat-value" id="lives">20</span>
                    </div>
                    <div class="stat-item">
                        <span>⚡ Dalga:</span>
                        <span class="stat-value" id="wave">1</span>
                    </div>
                    <div class="stat-item">
                        <span>🧟 Kalan:</span>
                        <span class="stat-value" id="enemiesRemaining">0</span>
                    </div>
                    <div class="stat-item">
                        <span>🏯 Kule:</span>
                        <span class="stat-value" id="towerCount">0</span>
                    </div>
                    <div class="stat-item" style="border:none;">
                        <span>🎯 İlerleme:</span>
                        <span class="stat-value" id="waveProgressLabel">0%</span>
                    </div>
                    <div class="progress-wrapper" style="width:100%;height:10px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden;margin:4px 0 10px;">
                        <div id="waveProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#27ae60,#2ecc71);transition:width .3s ease;"></div>
                    </div>
                </div>


                <div class="tower-shop">
                    <h3 style="color: #3498db; margin-bottom: 15px;">🏗️ Kule Mağazası</h3>
                    <button class="tower-button archer" onclick="selectTower('archer', 200, event)">
                        🏹 Okçu Kulesi - 200G
                    </button>
                    <button class="tower-button mage" onclick="selectTower('mage', 300, event)">
                        🔮 Büyücü Kulesi - 300G
                    </button>
                    <button class="tower-button cannon" onclick="selectTower('cannon', 500, event)">
                        💣 Top Kulesi - 500G
                    </button>
                    <button class="tower-button ice" onclick="selectTower('ice', 250, event)">
                        ❄️ Buz Kulesi - 250G
                    </button>
                </div>

                <div class="game-controls">
                    <button class="control-button start-wave" onclick="startWave()">
                        🚀 Dalga Başlat
                    </button>
                    <span id="waveHint">Önce en az bir kule yerleştir.</span>
                    <button class="control-button" id="speedButton" style="background: linear-gradient(45deg,#16a085,#1abc9c);" onclick="cycleSpeed()">⏩ Hız: 1x</button>
                    <button class="control-button pause-game" onclick="togglePause(event)">
                        ⏸️ Duraklat
                    </button>
                    <button class="control-button" style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white;" onclick="restartGame()">
                        🔄 Yeniden Başla
                    </button>
                    <button id="muteToggle" class="control-button" style="background: linear-gradient(45deg,#8e44ad,#9b59b6);" onclick="toggleMute()">🔊 Ses: Açık</button>
                    <label style="display:flex;align-items:center;gap:8px;font-size:14px;margin-top:4px;user-select:none;">
                        <input type="checkbox" id="autoNextWaveToggle" onchange="toggleAutoNextWave(event)" style="width:18px;height:18px;"> Otomatik Dalga
                    </label>
                </div>
                <div class="stats-panel" id="performancePanel" style="margin-top:10px;">
                    <div class="stat-item" style="border:none;display:flex;flex-direction:column;align-items:flex-start;gap:4px;width:100%;">
                        <span style="font-size:13px;opacity:0.8;">FPS / Performans</span>
                        <div style="display:flex;gap:12px;font-size:13px;flex-wrap:wrap;">
                            <span>FPS: <strong id="fpsValue">0</strong></span>
                            <span>Δms: <strong id="frameTime">0</strong></span>
                            <span>Düşman: <strong id="enemyCount">0</strong></span>
                            <span>Mermi: <strong id="projectileCount">0</strong></span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const gameBoard = document.getElementById('gameBoard');
        const goldDisplay = document.getElementById('gold');
        const livesDisplay = document.getElementById('lives');
    // Skor sistemi kaldırıldı
    const waveDisplay = document.getElementById('wave');
    const enemiesRemainingDisplay = document.getElementById('enemiesRemaining');
    const towerCountDisplay = document.getElementById('towerCount');
    const waveProgressBar = document.getElementById('waveProgressBar');
    const waveProgressLabel = document.getElementById('waveProgressLabel');
    const fpsValueEl = document.getElementById('fpsValue');
    const frameTimeEl = document.getElementById('frameTime');
    const enemyCountEl = document.getElementById('enemyCount');
    const projectileCountEl = document.getElementById('projectileCount');


        const towerActionsMenu = document.getElementById('towerActionsMenu');

        const gridSize = 50; // Izgara hücresi boyutu
        const cellSize = 50; // Kule ve hücrelerin görünür boyutu (GridSize ile aynı olmalı)

        let gameState = {
            gold: 600,
            lives: 20,
            // score kaldırıldı
            wave: 1,
            enemies: [],
            towers: [],
            selectedTowerType: null,
            selectedTowerCost: 0,
            projectiles: [],
            isPaused: false,
            gameOver: false,
            muted: false,
            autoStartNextWave: false,
            speedMultiplier: 1,
        };

        const towerCosts = {
            archer: 200,
            mage: 300,
            cannon: 500,
            ice: 250
        };

        const towerStats = {
            archer: { damage: 125, range: 200, fireRate: 750, projectileSpeed: 10, upgradeCost: 150 },
            mage: { damage: 150, range: 150, fireRate: 1000, projectileSpeed: 7, upgradeCost: 200 },
            cannon: { damage: 250, range: 180, fireRate: 1500, projectileSpeed: 6, splashRadius: 60, upgradeCost: 250 },
            ice: { damage: 75, range: 170, fireRate: 1200, slowEffect: 0.5, slowDuration: 2000, projectileSpeed: 7, upgradeCost: 200 }
        };

        const enemyTypes = {
            goblin: { hp: 500, speed: 1.5, gold: 15, score: 10, elementClass: 'enemy-goblin', armor: 0, width: 30, height: 30 },
            orc: { hp: 750, speed: 1.2, gold: 20, score: 15, elementClass: 'enemy-orc', armor: 1, width: 35, height: 35 },
            troll: { hp: 1000, speed: 1.3, gold: 35, score: 25, elementClass: 'enemy-troll', armor: 2, regen: 2, width: 40, height: 40 }, // Her saniye 2 HP yeniler
            shadow: { hp: 600, speed: 2, gold: 30, score: 20, elementClass: 'enemy-shadow', dodgeChance: 0.2, width: 35, height: 35 }, // %20 kaçınma şansı
            golem: { hp: 10000, speed: 1, gold: 60, score: 50, elementClass: 'enemy-golem', armor: 5, width: 50, height: 50 } // Yüksek zırh
        };

        // 10x20 grid için zigzag yol: En soldan başlar, sağa doğru zigzag yapar
        const pathPoints = [
            { x: 0, y: 0 },
            { x: 0, y: 200 },
            { x: 200, y: 200 },
            { x: 200, y: 100 },
            { x: 400, y: 100 },
            { x: 400, y: 300 },
            { x: 600, y: 300 },
            { x: 600, y: 0 },
            { x: 800, y: 0 },
            { x: 800, y: 400 },
            { x: 1000, y: 400 }, // En sağdan çıkış
        ];

        let numRows, numCols;
    let animationFrameId;
        let lastWaveTime = 0;

        let audioSystem;
        let forbiddenPathCells = new Set(); // Yolun geçtiği yasaklı hücrelerin koordinatlarını tutacak

        // Yeni: Ses sistemi oluşturma fonksiyonu
        function createAudioContext() {
            if (!audioSystem) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) {
                    console.warn("Web Audio API desteklenmiyor.");
                    return null;
                }
                const ctx = new AudioContext();
                return {
                    context: ctx,
                    playSound: function(frequency, duration, type = 'sine') {
                        if (!this.context) return;
                        const oscillator = this.context.createOscillator();
                        const gainNode = this.context.createGain();

                        oscillator.type = type;
                        oscillator.frequency.setValueAtTime(frequency, this.context.currentTime);
                        gainNode.gain.setValueAtTime(0.2, this.context.currentTime); // Ses seviyesi

                        oscillator.connect(gainNode);
                        gainNode.connect(this.context.destination);

                        oscillator.start();
                        gainNode.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + duration);
                        oscillator.stop(this.context.currentTime + duration);
                    }
                };
            }
            return audioSystem;
        }

        // Kullanıcı etkileşimi üzerine ses sistemini başlat
        document.addEventListener('click', function initAudio() {
            audioSystem = createAudioContext();
        }, { once: true });


        function updateUI() {
            goldDisplay.textContent = gameState.gold;
            livesDisplay.textContent = gameState.lives;
            waveDisplay.textContent = gameState.wave;

            if (towerCountDisplay) towerCountDisplay.textContent = gameState.towers.length;
            if (enemyCountEl) enemyCountEl.textContent = gameState.enemies.length;
            if (projectileCountEl) projectileCountEl.textContent = gameState.projectiles.length;

            if (typeof currentWaveTotal !== 'undefined') {
                if (enemiesRemainingDisplay) {
                    if (currentWaveTotal > 0) {
                        const remainingActive = gameState.enemies.length;
                        const remainingToSpawn = Math.max(0, currentWaveTotal - waveEnemySpawnIndex - currentWaveKilled);
                        enemiesRemainingDisplay.textContent = remainingActive + remainingToSpawn;
                    } else {
                        enemiesRemainingDisplay.textContent = 0;
                    }
                }
                if (waveProgressBar && waveProgressLabel) {
                    const ratio = currentWaveTotal > 0 ? (currentWaveKilled / currentWaveTotal) : 0;
                    waveProgressBar.style.width = (ratio * 100) + '%';
                    waveProgressLabel.textContent = Math.round(ratio * 100) + '%';
                }
            }

            document.querySelectorAll('.tower-button').forEach(button => {
                const type = button.classList[1];
                const cost = towerCosts[type];
                if (gameState.gold >= cost) {
                    button.removeAttribute('disabled');
                } else {
                    button.setAttribute('disabled', 'true');
                }
            });
        }

        // Yolun geçtiği tüm ızgara karelerini hesapla (sadeleştirilmiş)
        function getForbiddenPathCells() {
            const forbiddenCells = new Set();
            for (let i = 0; i < pathPoints.length - 1; i++) {
                const p1 = pathPoints[i];
                const p2 = pathPoints[i + 1];
                if (p1.x === p2.x) {
                    // Dikey segment
                    const [start, end] = [p1.y, p2.y].sort((a, b) => a - b);
                    for (let y = start; y <= end; y += gridSize) {
                        forbiddenCells.add(`${p1.x},${y}`);
                    }
                } else if (p1.y === p2.y) {
                    // Yatay segment
                    const [start, end] = [p1.x, p2.x].sort((a, b) => a - b);
                    for (let x = start; x <= end; x += gridSize) {
                        forbiddenCells.add(`${x},${p1.y}`);
                    }
                }
                // Dönüş noktalarını da ekle
                forbiddenCells.add(`${p1.x},${p1.y}`);
                forbiddenCells.add(`${p2.x},${p2.y}`);
            }
            return forbiddenCells;
        }


        function createGrid() {
            // Mevcut tüm ızgara hücrelerini ve kuleleri kaldır
            document.querySelectorAll('.grid-cell').forEach(cell => cell.remove());
            document.querySelectorAll('.tower').forEach(tower => tower.remove());
            document.querySelectorAll('.tower-range').forEach(range => range.remove());

            // gameState.towers dizisini de sıfırlayın
            gameState.towers = [];

            // Yasaklı hücreleri hesapla (bir kere çağır)
            forbiddenPathCells = getForbiddenPathCells();


            // Yeni ızgara boyutlarını hesapla
            numCols = Math.floor(gameBoard.offsetWidth / gridSize);
            numRows = Math.floor(gameBoard.offsetHeight / gridSize);

            for (let y = 0; y < numRows; y++) {
                for (let x = 0; x < numCols; x++) {
                    const cellX = x * gridSize;
                    const cellY = y * gridSize;

                    // Hücrenin yasaklı yol hücrelerinde olup olmadığını kontrol et
                    const isPath = forbiddenPathCells.has(`${cellX},${cellY}`);

                    // Eğer hücre yol üzerinde değilse, kule yerleştirilebilir bir `grid-cell` oluştur.
                    if (!isPath) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell');
                        // Hücreyi ızgaraya ve kule boyutuna göre ortala
                        cell.style.left = `${cellX + (gridSize - cellSize) / 2}px`;
                        cell.style.top = `${cellY + (gridSize - cellSize) / 2}px`;
                        cell.dataset.x = cellX;
                        cell.dataset.y = cellY;
                        cell.addEventListener('click', placeTower);
                        gameBoard.appendChild(cell);
                    }
                }
            }
        }

        function drawPath() {
            // Mevcut tüm yol parçalarını kaldır
            document.querySelectorAll('.path').forEach(p => p.remove());

            for (let i = 0; i < pathPoints.length - 1; i++) {
                const p1 = pathPoints[i];
                const p2 = pathPoints[i + 1];

                const pathDiv = document.createElement('div');
                pathDiv.classList.add('path');

                if (p1.x === p2.x) { // Dikey yol
                    pathDiv.style.width = `${gridSize}px`;
                    pathDiv.style.height = `${Math.abs(p2.y - p1.y) + gridSize}px`; // Uç noktayı da kapla
                    pathDiv.style.left = `${p1.x}px`;
                    pathDiv.style.top = `${Math.min(p1.y, p2.y)}px`;
                } else if (p1.y === p2.y) { // Yatay yol
                    pathDiv.style.width = `${Math.abs(p2.x - p1.x) + gridSize}px`; // Uç noktayı da kapla
                    pathDiv.style.height = `${gridSize}px`;
                    pathDiv.style.left = `${Math.min(p1.x, p2.x)}px`;
                    pathDiv.style.top = `${p1.y}px`;
                } else {
                    // Köşe dönüşleri için (opsiyonel olarak iki küçük div ile daha iyi görünebilir)
                    // Şimdilik sadece düz çizgiler çiziyoruz, köşeler birleşecektir.
                }
                gameBoard.appendChild(pathDiv);
            }
        }

        function selectTower(type, cost, event) {
            gameState.selectedTowerType = type;
            gameState.selectedTowerCost = cost;

            // Seçilen kule butonuna görsel geri bildirim ver
            document.querySelectorAll('.tower-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(440, 0.1, 'square'); // Seçim sesi
            }
        }

        function placeTower(event) {
            if (gameState.selectedTowerType && !gameState.isPaused) {
                const cellX = parseInt(event.currentTarget.dataset.x);
                const cellY = parseInt(event.currentTarget.dataset.y);

                // Bu hücrede zaten bir kule olup olmadığını kontrol et
                const existingTower = gameState.towers.find(t => t.x === cellX && t.y === cellY);
                if (existingTower) {
                    // Hücrede zaten kule var
                    return;
                }

                if (gameState.gold >= gameState.selectedTowerCost) {
                    gameState.gold -= gameState.selectedTowerCost;

                    const newTower = {
                        id: Date.now(),
                        type: gameState.selectedTowerType,
                        x: cellX,
                        y: cellY,
                        ...towerStats[gameState.selectedTowerType], // İstatistikleri kopyala
                        level: 1,
                        attackTimer: 0,
                        element: null, // DOM elementi
                        rangeElement: null, // Menzil göstergesi DOM elementi
                    };

                    createTowerElement(newTower);
                    gameState.towers.push(newTower);

                    gameState.selectedTowerType = null; // Kuleyi yerleştirdikten sonra seçimi sıfırla
                    gameState.selectedTowerCost = 0;
                    document.querySelectorAll('.tower-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    updateUI();

                    if (!gameState.muted && audioSystem) {
                        audioSystem.playSound(600, 0.1, 'triangle'); // Kule yerleştirme sesi
                    }
                    const wh = document.getElementById('waveHint');
                    if (wh) wh.style.display='none';
                    if (document.getElementById('onboardingOverlay') && !document.getElementById('onboardingOverlay').classList.contains('hidden')) hideOnboarding();
                } else {
                    // Yetersiz altın
                    if (!gameState.muted && audioSystem) {
                        audioSystem.playSound(200, 0.2, 'sawtooth'); // Hata sesi
                    }
                }
            }
        }

        function createTowerElement(tower) {
    const towerDiv = document.createElement('div');
    towerDiv.classList.add('tower', `tower-${tower.type}`);
    towerDiv.style.left = `${tower.x + (gridSize - cellSize) / 2}px`;
    towerDiv.style.top = `${tower.y + (gridSize - cellSize) / 2}px`;
    towerDiv.textContent = getTowerIcon(tower.type); // Kule ikonunu ayarla
    towerDiv.dataset.towerId = tower.id; // Kuleye ID atayın
    
        // Seviye rozeti
        const levelBadge = document.createElement('div');
        levelBadge.className = 'tower-level-badge';
        levelBadge.textContent = 'Lv1';
        levelBadge.setAttribute('data-lv','1');
        towerDiv.appendChild(levelBadge);
        tower.levelBadge = levelBadge;
    
    towerDiv.addEventListener('click', (e) => {
        e.stopPropagation(); // Olayın gameBoard'a yayılmasını engelle
        
        // Menzil göstergesini toggle et
        if (tower.rangeElement.style.display === 'none' || tower.rangeElement.style.display === '') {
            tower.rangeElement.style.display = 'block';
        } else {
            tower.rangeElement.style.display = 'none';
        }
        
        showTowerActions(tower);
    });
    
    gameBoard.appendChild(towerDiv);
    tower.element = towerDiv; // Kule elementini objeye kaydet

    // Menzil göstergesi oluştur
    const rangeDiv = document.createElement('div');
    rangeDiv.classList.add('tower-range');
    rangeDiv.style.width = `${tower.range * 2}px`;
    rangeDiv.style.height = `${tower.range * 2}px`;
    rangeDiv.style.left = `${tower.x + (cellSize / 2) - tower.range}px`;
    rangeDiv.style.top = `${tower.y + (cellSize / 2) - tower.range}px`;
    rangeDiv.style.display = 'none'; // Başlangıçta gizli
    
    gameBoard.appendChild(rangeDiv);
    tower.rangeElement = rangeDiv;
}

        function getTowerIcon(type) {
            switch (type) {
                case 'archer': return '🏹';
                case 'mage': return '🔮';
                case 'cannon': return '💣';
                case 'ice': return '❄️';
                default: return '❓';
            }
        }

        let currentActiveTower = null; // Şu anda menüsü açık olan kuleyi takip eder

        function showTowerActions(tower) {
            // Eğer farklı bir kule seçiliyse, o menüyü kapat
            if (currentActiveTower && currentActiveTower.id !== tower.id) {
                towerActionsMenu.style.display = 'none';
            }

            currentActiveTower = tower;

            // Menüyü kule pozisyonuna göre konumlandır
            towerActionsMenu.style.left = `${tower.x + cellSize + 10}px`; // Kulenin sağına
            towerActionsMenu.style.top = `${tower.y}px`;
            towerActionsMenu.style.display = 'flex'; // Menüyü göster

            // Menü içeriğini temizle
            towerActionsMenu.innerHTML = '';

            // Yükseltme butonu
            const upgradeButton = document.createElement('button');
            upgradeButton.classList.add('action-button', 'upgrade-button');
            upgradeButton.textContent = `Yükselt (Level ${tower.level + 1}) - ${tower.upgradeCost}G`;
            upgradeButton.onclick = () => upgradeTower(tower);
            if (gameState.gold < tower.upgradeCost || tower.level >= 3) { // Maksimum level 3 varsayalım
                upgradeButton.disabled = true;
                if (tower.level >= 3) upgradeButton.textContent = 'Maks Level';
            }
            towerActionsMenu.appendChild(upgradeButton);

            // Satış butonu
            const sellValue = Math.floor(towerCosts[tower.type] * 0.7); // Geri ödeme değeri
            const sellButton = document.createElement('button');
            sellButton.classList.add('action-button', 'sell-button');
            sellButton.textContent = `Sat - ${sellValue}G`;
            sellButton.onclick = () => sellTower(tower, sellValue);
            towerActionsMenu.appendChild(sellButton);

            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(500, 0.1, 'sine'); // Menü açılma sesi
            }
        }

        function upgradeTower(tower) {
            if (gameState.gold >= tower.upgradeCost && tower.level < 3) {
                gameState.gold -= tower.upgradeCost;
                tower.level++;
                tower.damage = Math.floor(tower.damage * 1.5); // Hasarı artır
                tower.fireRate = Math.floor(tower.fireRate * 0.8); // Atış hızını artır (ms azalt)
                tower.range = Math.floor(tower.range * 1.1); // Menzili artır
                tower.upgradeCost = Math.floor(tower.upgradeCost * 1.5); // Yükseltme maliyetini artır

                if (tower.type === 'cannon' && tower.splashRadius) {
                    tower.splashRadius = Math.min(tower.splashRadius + 10, 100); // Sıçrama alanını artır
                }
                if (tower.type === 'ice' && tower.slowEffect) {
                    tower.slowEffect = Math.min(tower.slowEffect + 0.1, 0.8); // Yavaşlatma etkisini artır
                }

                // Menzil göstergesini güncelle
                if (tower.rangeElement) {
                    tower.rangeElement.style.width = `${tower.range * 2}px`;
                    tower.rangeElement.style.height = `${tower.range * 2}px`;
                    tower.rangeElement.style.left = `${tower.x + (cellSize / 2) - tower.range}px`;
                    tower.rangeElement.style.top = `${tower.y + (cellSize / 2) - tower.range}px`;
                }

                // Seviye rozeti güncelle
                if (tower.levelBadge) {
                    tower.levelBadge.textContent = 'Lv' + tower.level;
                    tower.levelBadge.setAttribute('data-lv', String(tower.level));
                }

                updateUI();
                towerActionsMenu.style.display = 'none'; // Menüyü kapat
                if (!gameState.muted && audioSystem) {
                    audioSystem.playSound(700, 0.1, 'square'); // Yükseltme sesi
                }
            } else {
                if (!gameState.muted && audioSystem) {
                    audioSystem.playSound(200, 0.2, 'sawtooth'); // Hata sesi
                }
            }
        }

        function sellTower(tower, value) {
            gameState.gold += value;
            gameState.towers = gameState.towers.filter(t => t.id !== tower.id);
            if (tower.element) tower.element.remove();
            if (tower.rangeElement) tower.rangeElement.remove();
            updateUI();
            towerActionsMenu.style.display = 'none'; // Menüyü kapat
            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(300, 0.1, 'sine'); // Satış sesi
            }
        }

        // Oyun tahtasına tıklayınca menüyü kapat
        gameBoard.addEventListener('click', () => {
            towerActionsMenu.style.display = 'none';
            currentActiveTower = null;
        });

        function getDistance(x1, y1, x2, y2) { // Gerektiğinde gerçek mesafe (az kullanacağız)
            return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
        }

        function getDistanceSquared(x1, y1, x2, y2) { // Karekök almadan kıyaslama için
            const dx = x2 - x1;
            const dy = y2 - y1;
            return dx * dx + dy * dy;
        }

        function fireProjectile(tower, targetEnemy) {
            if (!tower.element || !targetEnemy.element) return;

            const towerCenterX = tower.x + cellSize / 2;
            const towerCenterY = tower.y + cellSize / 2;
            const enemyCenterX = targetEnemy.x + targetEnemy.element.offsetWidth / 2;
            const enemyCenterY = targetEnemy.y + targetEnemy.element.offsetHeight / 2;

            const projectile = {
                id: Date.now() + Math.random(),
                x: towerCenterX,
                y: towerCenterY,
                targetEnemy: targetEnemy,
                damage: tower.damage,
                speed: tower.projectileSpeed,
                type: tower.type, // Mermi tipini kule tipine göre ayarla
                element: document.createElement('div'),
                splashRadius: tower.splashRadius || 0, // Top kulesi için
                slowEffect: tower.slowEffect || 0, // Buz kulesi için
            };

            projectile.element.classList.add('projectile');
            if (projectile.type === 'mage') {
                projectile.element.style.backgroundColor = '#8e44ad'; // Büyücü mermisi mor
                projectile.element.style.boxShadow = '0 0 10px #8e44ad';
            } else if (projectile.type === 'cannon') {
                projectile.element.style.backgroundColor = '#c0392b'; // Top mermisi kırmızı
                projectile.element.style.width = '12px'; // Daha büyük
                projectile.element.style.height = '12px';
                projectile.element.style.boxShadow = '0 0 15px #c0392b';
            } else if (projectile.type === 'ice') {
                projectile.element.style.backgroundColor = '#3498db'; // Buz mermisi mavi
                projectile.element.style.boxShadow = '0 0 10px #3498db';
            }

            projectile.element.style.left = `${projectile.x}px`;
            projectile.element.style.top = `${projectile.y}px`;
            gameBoard.appendChild(projectile.element);
            gameState.projectiles.push(projectile);

            if (audioSystem && !gameState.muted) {
                if (tower.type === 'archer') audioSystem.playSound(800, 0.05, 'sine');
                if (tower.type === 'mage') audioSystem.playSound(600, 0.1, 'triangle');
                if (tower.type === 'cannon') audioSystem.playSound(100, 0.2, 'sawtooth');
                if (tower.type === 'ice') audioSystem.playSound(900, 0.08, 'square');
            }
        }

        function updateProjectiles(deltaTime) {
            gameState.projectiles = gameState.projectiles.filter(projectile => {
                if (!projectile.targetEnemy || !projectile.targetEnemy.element || projectile.targetEnemy.hp <= 0) {
                    projectile.element.remove();
                    return false;
                }

                const targetEnemyCenterX = projectile.targetEnemy.x + projectile.targetEnemy.element.offsetWidth / 2;
                const targetEnemyCenterY = projectile.targetEnemy.y + projectile.targetEnemy.element.offsetHeight / 2;

                const dx = targetEnemyCenterX - projectile.x;
                const dy = targetEnemyCenterY - projectile.y;
                const distSq = dx * dx + dy * dy;
                const speedStep = projectile.speed * (deltaTime / 16);
                if (distSq <= speedStep * speedStep) { // Hedefe ulaştı
                    applyDamage(projectile.targetEnemy, projectile.damage, projectile.type);

                    if (projectile.type === 'cannon' && projectile.splashRadius > 0) {
                        applySplashDamage(projectile.targetEnemy.x, projectile.targetEnemy.y, projectile.splashRadius, projectile.damage * 0.5); // Sıçrama hasarı %50
                        createParticleSystem(projectile.targetEnemy.x + 20, projectile.targetEnemy.y + 20, '#ff6b35', 50); // Patlama efekti
                    }

                    if (projectile.type === 'ice' && projectile.slowEffect > 0) {
                        applySlow(projectile.targetEnemy, projectile.slowEffect, projectile.slowDuration);
                        createParticleSystem(projectile.targetEnemy.x + 20, projectile.targetEnemy.y + 20, '#3498db', 20); // Buz efekti
                    }

                    projectile.element.remove();
                    return false;
                } else {
                    const distance = Math.sqrt(distSq) || 1;
                    const moveAmount = speedStep;
                    projectile.x += (dx / distance) * moveAmount;
                    projectile.y += (dy / distance) * moveAmount;

                    projectile.element.style.left = `${projectile.x}px`;
                    projectile.element.style.top = `${projectile.y}px`;
                    return true;
                }
            });
        }

        function applyDamage(enemy, damage, type) {
            // Kaçınma şansı
            if (enemy.dodgeChance && Math.random() < enemy.dodgeChance) {
                // Kaçındı efekti
                createDamageText(enemy.x + 20, enemy.y, "KAÇINDI!", '#ffffff'); // Beyaz kaçınma yazısı
                return;
            }

            // Zırh hesaplaması
            const effectiveDamage = Math.max(1, damage - enemy.armor); // En az 1 hasar versin
            enemy.hp -= effectiveDamage;
            // Hasar uygulandı

            createDamageText(enemy.x + 20, enemy.y - 10, `-${effectiveDamage}`, '#ff0000'); // Kırmızı hasar yazısı

            // Sağlık çubuğunu güncelle
            if (enemy.healthBarFill) {
                enemy.healthBarFill.style.width = `${Math.max(0, (enemy.hp / enemy.maxHp) * 100)}%`;
            }

            if (enemy.hp <= 0) {
                killEnemy(enemy);
            }
        }

        function applySplashDamage(centerX, centerY, radius, damage) {
            gameState.enemies.forEach(enemy => {
                if (enemy.hp > 0) {
                    const enemyCenterX = enemy.x + enemy.element.offsetWidth / 2;
                    const enemyCenterY = enemy.y + enemy.element.offsetHeight / 2;
                    if (getDistance(centerX, centerY, enemyCenterX, enemyCenterY) <= radius) {
                        applyDamage(enemy, damage, 'splash'); // Sıçrama hasarı
                    }
                }
            });
        }

        function applySlow(enemy, effect, duration) {
            // Zaten yavaşlamışsa süreyi yenile veya daha güçlü etkiyi uygula
            if (enemy.isSlowed && enemy.slowEffect >= effect) {
                clearTimeout(enemy.slowTimer);
            } else if (enemy.isSlowed && enemy.slowEffect < effect) {
                enemy.speed = enemy.initialSpeed; // Önceki yavaşlamayı kaldır
            }

            enemy.initialSpeed = enemy.initialSpeed || enemy.speed; // İlk hızı kaydet
            enemy.speed = enemy.initialSpeed * (1 - effect);
            enemy.isSlowed = true;
            enemy.slowEffect = effect; // Uygulanan yavaşlatma etkisini kaydet

            // Görsel geri bildirim
            if (enemy.element) {
                enemy.element.style.filter = 'grayscale(70%) brightness(1.5)';
                enemy.element.style.transition = 'filter 0.5s ease-out';
            }


            enemy.slowTimer = setTimeout(() => {
                enemy.speed = enemy.initialSpeed;
                enemy.isSlowed = false;
                enemy.slowEffect = 0;
                if (enemy.element) {
                    enemy.element.style.filter = 'none';
                }
            }, duration);
        }

        function createDamageText(x, y, text, color) {
            const damageText = document.createElement('div');
            damageText.classList.add('damage-text');
            damageText.textContent = text;
            damageText.style.left = `${x}px`;
            damageText.style.top = `${y}px`;
            damageText.style.color = color;
            gameBoard.appendChild(damageText);

            damageText.addEventListener('animationend', () => {
                damageText.remove();
            });
        }

        function killEnemy(enemy) {
            if (enemy.element) {
                enemy.element.remove();
                if (enemy.healthBar) enemy.healthBar.remove();
            }
            gameState.gold += enemy.gold;
            createParticleSystem(enemy.x + 20, enemy.y + 20, '#f7dc6f', 30); // Altın rengi partiküller
            gameState.enemies = gameState.enemies.filter(e => e.id !== enemy.id); // Diziden kaldır
            if (currentWaveTotal > 0) currentWaveKilled++;
            updateUI();

            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(1000, 0.1, 'square'); // Düşman ölüm sesi
            }
        }

        function updateEnemies(deltaTime) {
            gameState.enemies.forEach(enemy => {
                if (enemy.hp <= 0) return;

                // Regen (HP yenileme)
                if (enemy.regen) {
                    enemy.hp = Math.min(enemy.maxHp, enemy.hp + enemy.regen * (deltaTime / 1000)); // Her saniye regen
                    if (enemy.healthBarFill) {
                        enemy.healthBarFill.style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;
                    }
                }

                const currentPathPoint = pathPoints[enemy.pathIndex];
                const nextPathPoint = pathPoints[enemy.pathIndex + 1];

                if (!nextPathPoint) { // Yola ulaştı
                    gameState.lives--;
                    if (!gameState.muted && audioSystem) {
                        audioSystem.playSound(50, 0.3, 'sine'); // Can kaybı sesi
                    }
                    if (enemy.element) {
                        enemy.element.remove();
                        if (enemy.healthBar) enemy.healthBar.remove();
                    }
                    gameState.enemies = gameState.enemies.filter(e => e.id !== enemy.id);
                    updateUI();
                    return;
                }

                const dx = nextPathPoint.x - enemy.x;
                const dy = nextPathPoint.y - enemy.y;
                const distanceToNextPoint = Math.sqrt(dx * dx + dy * dy);

                const moveAmount = enemy.speed * (deltaTime / 16); // Kare hızına göre ayarla

                if (distanceToNextPoint < moveAmount) {
                    enemy.x = nextPathPoint.x;
                    enemy.y = nextPathPoint.y;
                    enemy.pathIndex++;
                } else {
                    enemy.x += (dx / distanceToNextPoint) * moveAmount;
                    enemy.y += (dy / distanceToNextPoint) * moveAmount;
                }

                if (enemy.element) {
                    // Transform denemesi görsel bozulma yaptıysa klasik left/top'a geri dön
                    const ex = enemy.x + (gridSize - enemy.element.offsetWidth) / 2;
                    const ey = enemy.y + (gridSize - enemy.element.offsetHeight) / 2;
                    enemy.element.style.left = ex + 'px';
                    enemy.element.style.top = ey + 'px';
                }
            });
        }

        function createEnemy(type) {
            const enemy = {
                id: Date.now() + Math.random(),
                type: type,
                x: pathPoints[0].x,
                y: pathPoints[0].y,
                pathIndex: 0,
                hp: enemyTypes[type].hp,
                maxHp: enemyTypes[type].hp, // Maksimum HP'yi sakla
                speed: enemyTypes[type].speed,
                gold: enemyTypes[type].gold,
                score: enemyTypes[type].score,
                element: null, // DOM elementi
                healthBar: null, // Sağlık çubuğu elementi
                healthBarFill: null, // Sağlık çubuğu dolum elementi
                armor: enemyTypes[type].armor || 0,
                dodgeChance: enemyTypes[type].dodgeChance || 0,
                regen: enemyTypes[type].regen || 0,
                isSlowed: false,
                slowEffect: 0,
                slowTimer: null,
                initialSpeed: enemyTypes[type].speed, // Yavaşlamayı geri almak için
            };

            const enemyDiv = document.createElement('div');
            enemyDiv.classList.add('enemy', enemyTypes[type].elementClass);
            // Düşman boyutlarını enemyTypes'tan al, ortalamayı da hesapla
            enemyDiv.style.width = `${enemyTypes[type].width}px`;
            enemyDiv.style.height = `${enemyTypes[type].height}px`;
            enemyDiv.style.left = `${enemy.x + (gridSize - enemyTypes[type].width) / 2}px`;
            enemyDiv.style.top = `${enemy.y + (gridSize - enemyTypes[type].height) / 2}px`;
            enemyDiv.innerHTML = getEnemyIcon(type); // Düşman ikonunu ayarla
            gameBoard.appendChild(enemyDiv);
            enemy.element = enemyDiv;

            // Sağlık çubuğu oluştur
            const healthBar = document.createElement('div');
            healthBar.classList.add('health-bar');
            const healthFill = document.createElement('div');
            healthFill.classList.add('health-fill');
            healthBar.appendChild(healthFill);
            enemyDiv.appendChild(healthBar); // Düşman div'inin içine ekle
            enemy.healthBar = healthBar;
            enemy.healthBarFill = healthFill;


            gameState.enemies.push(enemy);
            updateUI();
        }

        function getEnemyIcon(type) {
            switch (type) {
                case 'goblin': return '😈';
                case 'orc': return '👹';
                case 'troll': return '🧌';
                case 'shadow': return '👻';
                case 'golem': return '🗿';
                default: return '❓';
            }
        }

        function getWaveEnemies(waveNumber) {
            const enemies = [];
            let totalEnemies = 5 + waveNumber * 2; // Dalga ile düşman sayısını artır

            for (let i = 0; i < totalEnemies; i++) {
                let enemyType;
                const rand = Math.random();
                if (waveNumber < 3) {
                    enemyType = 'goblin';
                } else if (waveNumber < 6) {
                    if (rand < 0.7) enemyType = 'goblin';
                    else enemyType = 'orc';
                } else if (waveNumber < 9) {
                    if (rand < 0.5) enemyType = 'orc';
                    else if (rand < 0.8) enemyType = 'troll';
                    else enemyType = 'shadow';
                } else {
                    if (rand < 0.4) enemyType = 'troll';
                    else if (rand < 0.7) enemyType = 'shadow';
                    else enemyType = 'golem';
                }
                enemies.push(enemyType);
            }
            return enemies;
        }


        let waveEnemySpawnIndex = 0;
        let waveSpawnInterval;
        let currentWaveEnemies = [];
    let currentWaveTotal = 0;
    let currentWaveKilled = 0;
    let fpsLastSample = performance.now();
    let framesSinceSample = 0;

        function startWave() {
            if (gameState.isPaused || gameState.gameOver) return;
            if (gameState.enemies.length > 0) return; // Mevcut düşmanlar varken başlatma
            if (gameState.towers.length === 0) {
                const wh = document.getElementById('waveHint');
                if (wh) wh.textContent = 'Dalga başlamadan önce bir kule yerleştir!';
                return;
            }
            const wh = document.getElementById('waveHint');
            if (wh) wh.style.display = 'none';
            if (document.getElementById('onboardingOverlay') && !document.getElementById('onboardingOverlay').classList.contains('hidden')) {
                hideOnboarding();
            }

            gameState.wave++;
            currentWaveEnemies = getWaveEnemies(gameState.wave);
            currentWaveTotal = currentWaveEnemies.length;
            currentWaveKilled = 0;
            waveEnemySpawnIndex = 0;

            const baseSpawn = 700;
            const spawnDelay = baseSpawn / (gameState.speedMultiplier || 1);
            waveSpawnInterval = setInterval(() => {
                if (waveEnemySpawnIndex < currentWaveEnemies.length) {
                    createEnemy(currentWaveEnemies[waveEnemySpawnIndex]);
                    waveEnemySpawnIndex++;
                    updateUI();
                } else {
                    clearInterval(waveSpawnInterval);
                }
            }, spawnDelay);

            updateUI();
            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(650, 0.2, 'sine'); // Dalga başlangıç sesi
            }
        }

        function gameLoop(timestamp) {
            if (gameState.isPaused || gameState.gameOver) {
                animationFrameId = requestAnimationFrame(gameLoop);
                return;
            }

            const deltaTime = timestamp - lastWaveTime;
            lastWaveTime = timestamp;
            const scaled = deltaTime * (gameState.speedMultiplier || 1);

            updateTowers(scaled);
            updateEnemies(scaled);
            updateProjectiles(scaled);

            if (gameState.lives <= 0) {
                endGame();
            }

            if (gameState.enemies.length === 0 && waveEnemySpawnIndex >= currentWaveEnemies.length && gameState.wave > 0) {
                if (currentWaveTotal > 0) {
                    currentWaveTotal = 0;
                    currentWaveKilled = 0;
                    updateUI();
                    if (gameState.autoStartNextWave) {
                        startWave();
                    }
                }
            }
            animationFrameId = requestAnimationFrame(gameLoop);

            // FPS hesaplama
            framesSinceSample++;
            if (timestamp - fpsLastSample >= 1000) {
                const elapsed = timestamp - fpsLastSample;
                const fps = framesSinceSample * 1000 / elapsed;
                if (fpsValueEl) fpsValueEl.textContent = fps.toFixed(0);
                if (frameTimeEl) frameTimeEl.textContent = (elapsed / framesSinceSample).toFixed(1);
                fpsLastSample = timestamp;
                framesSinceSample = 0;
            }
        }

        function togglePause(event) {
            gameState.isPaused = !gameState.isPaused;
            event.target.textContent = gameState.isPaused ? '▶️ Devam Et' : '⏸️ Duraklat';
            if (gameState.isPaused) {
                cancelAnimationFrame(animationFrameId);
                clearInterval(waveSpawnInterval);
                // Oyun duraklatıldı
            } else {
                lastWaveTime = performance.now(); // Duraklatmadan sonra zamanı sıfırla
                animationFrameId = requestAnimationFrame(gameLoop);
                if (waveEnemySpawnIndex < currentWaveEnemies.length) { // Dalga yarım kaldıysa devam ettir
                    const baseSpawn = 700;
                    const spawnDelay = baseSpawn / (gameState.speedMultiplier || 1);
                    waveSpawnInterval = setInterval(() => {
                        if (waveEnemySpawnIndex < currentWaveEnemies.length) {
                            createEnemy(currentWaveEnemies[waveEnemySpawnIndex]);
                            waveEnemySpawnIndex++;
                        } else {
                            clearInterval(waveSpawnInterval);
                        }
                    }, spawnDelay);
                }
                // Oyun devam ediyor
            }
            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(550, 0.1, 'sine'); // Duraklatma sesi
            }
        }

        function restartGame() {
            // Tüm elementleri temizle
            document.querySelectorAll('.enemy').forEach(e => e.remove());
            document.querySelectorAll('.tower').forEach(t => t.remove());
            document.querySelectorAll('.tower-range').forEach(r => r.remove());
            document.querySelectorAll('.projectile').forEach(p => p.remove());
            document.querySelectorAll('.grid-cell').forEach(c => c.remove());
            document.querySelectorAll('.path').forEach(p => p.remove());
            document.querySelectorAll('.explosion').forEach(e => e.remove());
            document.querySelectorAll('.damage-text').forEach(d => d.remove());
            // Eski power-up sistemi kaldırıldı

            // Tüm zamanlayıcıları temizle
            cancelAnimationFrame(animationFrameId);
            clearInterval(waveSpawnInterval);

            // Oyun durumunu sıfırla
            gameState = {
                gold: 500,
                lives: 20,
                score: 0,
                wave: 0, // Dalga 0'dan başlasın, ilk dalga başlatılınca 1 olsun
                enemies: [],
                towers: [],
                selectedTowerType: null,
                selectedTowerCost: 0,
                projectiles: [],
                isPaused: false,
                gameOver: false,
                muted: gameState.muted || false,
                autoStartNextWave: gameState.autoStartNextWave || false,
                speedMultiplier: gameState.speedMultiplier || 1,
            };

            // UI'ı güncelle
            updateUI();
            document.querySelector('.pause-game').textContent = '⏸️ Duraklat'; // Duraklat butonunu sıfırla

            // Izgarayı ve yolu yeniden çiz
            createGrid();
            drawPath();

            // Yeni dalga için hazırlık
            waveEnemySpawnIndex = 0;
            currentWaveEnemies = []; // Dalga başlangıcı butonu ile başlasın
            currentWaveTotal = 0;
            currentWaveKilled = 0;

            // Oyun döngüsünü başlat
            lastWaveTime = performance.now();
            animationFrameId = requestAnimationFrame(gameLoop);
            // Eski power-up sistemi kaldırıldı
            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(750, 0.2, 'square'); // Oyun yeniden başlama sesi
            }
            // Oyun yeniden başlatıldı
            // Onboarding'i yeniden göster
            showOnboarding();
            const whMsg = document.getElementById('waveHint');
            if (whMsg) { whMsg.style.display='block'; whMsg.textContent='Önce en az bir kule yerleştir.'; }
        }


        function endGame() {
            gameState.gameOver = true;
            cancelAnimationFrame(animationFrameId);
            clearInterval(waveSpawnInterval);
            showGameOver();

            if (!gameState.muted && audioSystem) {
                audioSystem.playSound(100, 0.5, 'triangle'); // Oyun bitti sesi
            }
            // Oyun bitti
        }

        function showGameOver() {
            const overlay = document.getElementById('gameOverOverlay');
            if (!overlay) return;
            const stats = document.getElementById('finalStats');
            stats.innerHTML = `🏅 Dalga: <strong>${gameState.wave}</strong><br>💰 Altın: <strong>${gameState.gold}</strong>`;
            overlay.classList.add('active');
        }

        function hideGameOver() {
            const overlay = document.getElementById('gameOverOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        function restartGameFromOverlay() {
            hideGameOver();
            restartGame();
        }

        function cycleSpeed() {
            if (gameState.speedMultiplier === 1) gameState.speedMultiplier = 2;
            else if (gameState.speedMultiplier === 2) gameState.speedMultiplier = 3;
            else gameState.speedMultiplier = 1;
            const btn = document.getElementById('speedButton');
            if (btn) btn.textContent = `⏩ Hız: ${gameState.speedMultiplier}x`;
            // Aktif dalga spawn interval varsa güncelle
            if (waveSpawnInterval && waveEnemySpawnIndex < currentWaveEnemies.length) {
                clearInterval(waveSpawnInterval);
                const baseSpawn = 700;
                const spawnDelay = baseSpawn / (gameState.speedMultiplier || 1);
                waveSpawnInterval = setInterval(() => {
                    if (waveEnemySpawnIndex < currentWaveEnemies.length) {
                        createEnemy(currentWaveEnemies[waveEnemySpawnIndex]);
                        waveEnemySpawnIndex++;
                        updateUI();
                    } else {
                        clearInterval(waveSpawnInterval);
                    }
                }, spawnDelay);
            }
        }


        let towerBatchFlip = false;
        function updateTowers(deltaTime) { // Kuleleri iki batch'e böl (frame alternation)
            towerBatchFlip = !towerBatchFlip;
            const len = gameState.towers.length;
            const start = towerBatchFlip ? 0 : Math.floor(len / 2);
            const end = towerBatchFlip ? Math.floor(len / 2) : len;
            for (let i = start; i < end; i++) {
                const tower = gameState.towers[i];
                tower.attackTimer += deltaTime;
                if (tower.attackTimer >= tower.fireRate) {
                    const targetEnemy = findTarget(tower);
                    if (targetEnemy) {
                        fireProjectile(tower, targetEnemy);
                        tower.attackTimer = 0;
                    }
                }
            }
        }

        function findTarget(tower) {
            // Menzildeki yol üzerinde en ilerlemiş (en yüksek pathIndex, eşitse segmentte en ileride) düşmanı bul
            const towerCenterX = tower.x + cellSize / 2;
            const towerCenterY = tower.y + cellSize / 2;
            let bestEnemy = null;
            let bestProgress = -1;

            gameState.enemies.forEach(enemy => {
                if (enemy.hp <= 0 || !enemy.element) return;
                const enemyCenterX = enemy.x + enemy.element.offsetWidth / 2;
                const enemyCenterY = enemy.y + enemy.element.offsetHeight / 2;
                const distSq = getDistanceSquared(towerCenterX, towerCenterY, enemyCenterX, enemyCenterY);
                if (distSq <= tower.range * tower.range) {
                    // Yol üzerindeki ilerleme: önce pathIndex, eşitse segmentteki ilerleme oranı
                    let progress = enemy.pathIndex;
                    const nextPoint = pathPoints[enemy.pathIndex + 1];
                    const currPoint = pathPoints[enemy.pathIndex];
                    if (nextPoint && currPoint) {
                        const segDx = nextPoint.x - currPoint.x;
                        const segDy = nextPoint.y - currPoint.y;
                        const totalSeg = Math.sqrt(segDx * segDx + segDy * segDy);
                        const curDx = nextPoint.x - enemy.x;
                        const curDy = nextPoint.y - enemy.y;
                        const currSeg = Math.sqrt(curDx * curDx + curDy * curDy);
                        if (totalSeg > 0) {
                            progress += 1 - (currSeg / totalSeg);
                        }
                    }
                    if (progress > bestProgress) {
                        bestProgress = progress;
                        bestEnemy = enemy;
                    }
                }
            });
            return bestEnemy;
        }

        // Partikül Sistemi
        function createParticleSystem(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.position = 'absolute';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = '5px';
                particle.style.height = '5px';
                particle.style.borderRadius = '50%';
                particle.style.background = color;
                gameBoard.appendChild(particle);

                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2; // 2 ile 7 arasında hız
                const dx = Math.cos(angle) * speed;
                const dy = Math.sin(angle) * speed;

                let currentX = x;
                let currentY = y;
                let opacity = 1;

                const animateParticle = () => {
                    if (opacity <= 0.1) {
                        particle.remove();
                        return;
                    }
                    currentX += dx;
                    currentY += dy;
                    opacity -= 0.05;

                    particle.style.left = `${currentX}px`;
                    particle.style.top = `${currentY}px`;
                    particle.style.opacity = opacity;

                    requestAnimationFrame(animateParticle);
                };
                animateParticle();
            }
            // CSS animasyonu ekle (eğer daha önce eklenmediyse)
            if (!document.querySelector('style[data-particle-animation]')) {
                const style = document.createElement('style');
                style.setAttribute('data-particle-animation', '');
                style.textContent += `
                    .particle {
                        pointer-events: none;
                        z-index: 100;
                    }
                `;
                document.head.appendChild(style);
            }
        }

    // (Power-up sistemi kaldırıldı)


        // Oyun Başlangıcı
        document.addEventListener('DOMContentLoaded', () => {
            // numRows ve numCols'un doğru hesaplandığından emin olmak için DOMContentLoaded'da
            // ve window.addEventListener('resize') içinde createGrid'i çağırırken dikkatli olun.
            // gameBoard'un boyutları CSS'te sabitlendiği için, bu değerler bir kez hesaplanabilir.
            numCols = Math.floor(gameBoard.offsetWidth / gridSize);
            numRows = Math.floor(gameBoard.offsetHeight / gridSize);

            createGrid();
            drawPath();
            updateUI();
            lastWaveTime = performance.now();
            animationFrameId = requestAnimationFrame(gameLoop);
            // Power-up sistemi yok
            adaptLayout();
            showOnboarding();
            const whMsg0 = document.getElementById('waveHint');
            if (whMsg0 && gameState.towers.length === 0) whMsg0.style.display='block';
        });

        // Pencere yeniden boyutlandırıldığında ızgarayı ve yolu yeniden çiz
        window.addEventListener('resize', () => {
             // Duyarlılık CSS'i devreye girdiğinde veya gameBoard'un boyutu değiştiğinde
             // numCols ve numRows'u yeniden hesapla.
            numCols = Math.floor(gameBoard.offsetWidth / gridSize);
            numRows = Math.floor(gameBoard.offsetHeight / gridSize);
            createGrid(); // grid-cell'leri yeniden oluştur
            drawPath(); // yolu yeniden çiz
            adaptLayout();
        });

        function toggleMute() {
            gameState.muted = !gameState.muted;
            const btn = document.getElementById('muteToggle');
            if (btn) btn.textContent = gameState.muted ? '🔇 Ses: Kapalı' : '🔊 Ses: Açık';
        }

        // Onboarding göster/gizle fonksiyonları
        function showOnboarding() {
            const ob = document.getElementById('onboardingOverlay');
            if (ob) ob.classList.remove('hidden');
        }
        function hideOnboarding() {
            const ob = document.getElementById('onboardingOverlay');
            if (ob) ob.classList.add('hidden');
        }

        function toggleAutoNextWave(e) {
            gameState.autoStartNextWave = e.target.checked;
        }

        function adaptLayout() {
            const baseWidth = 1000;
            const baseHeight = 500;
            const availableWidth = window.innerWidth - 300; // sidebar tahmini
            const availableHeight = window.innerHeight - 40;
            let scale = Math.min(availableWidth / baseWidth, availableHeight / baseHeight);
            if (window.innerWidth < 1100) {
                scale = Math.min(window.innerWidth * 0.95 / baseWidth, window.innerHeight * 0.55 / baseHeight);
            }
            if (scale < 1) {
                gameBoard.style.transformOrigin = 'top left';
                gameBoard.style.transform = `scale(${scale})`;
            } else {
                gameBoard.style.transform = 'none';
            }
        }

        /* Kaydet/Yükle kod blokları tamamen kaldırıldı */

        /* Kaydet/Yükle tamamen kaldırıldı: localStorage erişimi yok. */

    </script>
</body>
</html>